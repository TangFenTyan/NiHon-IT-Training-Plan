# React-based Goods Trade System

## 流程图示

基本思路：设计并编写出一套能够实现完整交易流程的P2P二手交易系统，在尽量精细化用户端细节功能的同时，也加入管理端的权限调配来与用户端产生作用影响

![](https://github.com/toubun24/NiHon-IT-Training-Plan/blob/main/imgStorage/GTS202401241825.png)

参考"闲鱼"，对用户交易流程做了简单流程图示。同时，可以将该网站的使用角色分为：
* 用户：同时具有客户和商户的特性，可发布或购买商品
* 管理员：对用户的商品发布进行内容审核，且在退货申诉时做出判断，还可视情况限制用户的发布或购买权限甚至封号
* 超级管理员：除了普通管理员具有的权限外，还可以管理管理员帐号的权限以及对标签进行管理，不合适的标签在用户创建时不会报错，但不会再进行展示

## 项目目标需求分析
基于前述业务流程分析，对于拟搭建平台所需实现功能的初步构想如下：
* **用户注册功能**：新注册用户需注意重名校验问题；可以提供默认地址与上传头像（均为非必填项）。前者会在发布商品时默认填充地址栏，后者则会替代原本的默认头像；个人主页还提供修改头像功能；用户数据注册时新增注册时间，方便在个人主页展示计算创号天数
* **用户管理功能**：管理员负责商品发布审核与申诉处理
* **主页展示功能**：用户展示主页信息，方便其他用户快速了解与评估
* **商品管理功能**：用户可以发布与修改商品详情，且能被其他用户通过板块tag或关键字搜索到；下单后卖家可根据先前洽谈好的价格对订单进行改价后买家再进行付款
* **权限管理功能**：管理员可以限制用户发布或购买权限或顶格直接封号，其相关的内容也将被限制访问；具体而言,禁购时，商品详情页无法购买，且无法进入顶部栏商品搜索页查看其他商品，登录后由原先的默认跳转商品搜索页变成跳转到主页；禁售时，顶部栏无法使用商品发布功能，登录后同样会有消息提醒；封禁时，视为同时禁购和禁售，但保留历史订单查看等侧边栏功能，且禁止主页充值或修改信息；已注销时，无法登陆
* **订单评价功能**：交易完成后，买家可对交易进行评价，且该评价也会展示到对应的卖家的主页信息中；默认满分好评；评价星数和订单详情中的星数会进行展示
* **退货申诉功能**：买家在订单完成确认时可以发起申诉，首先由商家进行处理，商家拒绝退货时需写明原因并移交管理员处理
* **交易快照功能**：交易双方和管理员可以从交易订单中链接到下单时的商品描述页面（无视卖家后续的修改）
* **商品展示功能**: 商品详情页中，如果是自己发布的商品，则仅显示修改按钮；他人发布的商品则显示购买或收藏按钮，且可对发布者进行关注操作；管理员看到的界面则是权限控制相关
* **权限控制功能**：交易双方和管理员可以从交易订单中链接到下单时的商品描述页面（无视卖家后续的修改）
* **收藏关注功能**: 对他人的商品收藏或关注会在自己的主页展示中筛选出收藏过的商品，卖方主页也会统计相关数字，有多少人对自己发布的商品进行了收藏，又有多少人关注了自己
* **头像展示功能**: 头像组件如果没有相关联的上传图片做头像，则会启用默认头像格式，具体形式为底色+用户名前缀；有图片则显示头像图片；个人主页还提供修改头像功能
* **标签标记功能**: 可在发布商品时填写tag（重复tag会在提交前进行唯一化处理，不会重复提交），且同名tag会进行计数，体现热度，也会在搜索页通过tag进行展示和查找；在商品详情中展示的tag对其进行点击也能直接跳转到对应tag的分类过滤商品列表中；被屏蔽的不合适标签不会被渲染到商品详情界面，但依然会在后台继续记录相应的数据，直到某个时候被解除屏蔽
* **催促发货功能**: 买方催发快递后，卖方发货填写单号的地方会出现讨嫌的小红点，不发货就一直存在，订单详情中也会对此进行标注
* **仲裁统计功能**: 给管理员分别记录其完成的发布审查件数和申诉仲裁件数；同时，在审核或仲裁后记录当时操作的管理员名称，用户可以在【发布中】查看
* **权限控制功能**: 1. goods/modify/:id仅在tokenId和该商品创建者id相同时展示；2. goods/order/:id仅在tokenId和该商品创建者id不同时展示（自己不能购买自己创建的商品；禁购用户goods/order全都不能打开所以不用再单独去设置了）；3. snapshots/:id和orders/:id仅在管理员级别账户或者sellerId或buyerId对得上tokenId时进行展示订单详情；此外，该id所关联的内容不存在于数据库中时也跳转404；对特定标签的搜索也遵循权限控制，state为1意味着被超级管理员认为是不适合展示的标签，此时虽然所有页面上都不会再对该标签进行展示，手动输入url也依然会进行权限控制判断
* **并发队列处理功能**：引入RabbitMQ处理多用户高并发状态下的订单等请求处理
* **用户聊天功能**：用户间可进行对话框聊天，发送内容可包括文本和图片。【群聊】【转发】
* **登录认证授权功能**：利用Spring Security实现验证用户的身份、决定用户是否有权访问特定的资源、攻击防护（如跨站脚本（XSS）、跨站请求伪造（CSRF）、SQL 注入等）、管理用户的会话（包括会话的创建、维护和销毁）、密码管理（提供强大的密码加密和散列功能，以保护存储在数据库中的用户密码）
* **API数据接口功能**：促进第三方集成，增强用户体验，扩展业务模型，提高开发效率，促进数据共享和分析，支持自动化和机器人化，增强安全性和合规性
* **异常处理日志功能**：Log4j、Logback、SLF4J等框架提供了灵活的日志配置和强大的日志处理能力。（在代码的关键位置（如API接口的实现、业务逻辑的处理、异常捕获等）添加日志记录语句）
* **快递查询功能**：通过快递100的API，根据快递单号查询物流情况，自动呈现在订单页面进行展示

## 项目实现
基于前述项目目标分析，计划制作3个页面，包括注册登录页面（用户可注册，管理员账号无法新注册），用户页面和管理员页面，具体顶部栏与侧边栏分配如下
* 注册登录页面
* 用户页面
  * 推荐搜索页
  * 发布商品页
  * 个人主页
    * 已发布
      * 发布中
      * 草稿箱
      * 已下架
    * 已卖出
      * 全部
      * 待付款
      * 待发货
      * 待收货
      * 待评价
      * 申诉中
      * 已取消
      * 已完成
    * 已买到
      * 全部
      * 待付款
      * 待发货
      * 待收货
      * 待评价
      * 申诉中
      * 已取消
      * 已完成
* 管理员页面
  * 用户管理
    * 用户权限
    * 发布审核
  * 申诉管理
    * 待处理
    * 已完成
  * 超级管理
    * 账号管理
    * 标签管理

## 技术实现

### 前端：React
- **React** 是一个用于构建用户界面的 JavaScript 库，特别适合构建大型、复杂的应用程序。它使用组件化的开发模式，使得代码更加模块化，易于维护和扩展。
- **合理性**：React 是当前最流行的前端框架之一，非常适合用于构建复杂的电商网站。

### 前后端通信：Axios
- **Axios** 是一个基于 Promise 的 HTTP 客户端，适用于浏览器和 node.js。它可以很容易地发送异步 HTTP 请求到 REST 端点并处理响应。
- **合理性**：Axios 是与后端进行通信的理想选择，特别是在需要处理多种 HTTP 请求和响应的场景中。

### 后端框架：SpringBoot
- **Spring Boot** 是 Spring 框架的扩展，它提供了大量的默认配置来简化基于 Spring 的应用开发。这使得开发者可以更快地构建和运行应用程序。
- **合理性**：Spring Boot 非常适合用于构建企业级应用，它提供了丰富的功能和良好的社区支持。

### 服务器：Docker + MySQL
- **Docker** 是一个开源的应用容器引擎，让开发者可以打包他们的应用以及依赖包到一个可移植的容器中，然后发布到任何流行的 Linux 机器上，也可以实现虚拟化。
- **MySQL** 是一个流行的关系型数据库管理系统，用于存储和管理数据。
- **合理性**：使用 Docker 来运行 MySQL 提供了环境隔离和版本控制的好处，使得数据库部署和管理更加便捷。

### 依赖管理：Maven
- **Maven** 是一个项目管理和理解工具，它基于项目对象模型（POM）的概念。Maven 可以从中央仓库自动下载项目依赖，并管理项目的构建、报告和文档。
- **合理性**：Maven 是 Java 生态系统中广泛使用的依赖管理工具，非常适合用于 Spring Boot 项目。

### 数据持久化：MyBatis(JPA(Java Persistence API)方式也测试完成)
- **MyBatis** 是一个支持普通 SQL 查询、存储过程和高级映射的持久层框架。MyBatis 避免了几乎所有的 JDBC 代码和手动设置参数以及获取结果集。
- **合理性**：虽然 Spring Data JPA 是另一个流行的选择，但 MyBatis 提供了更细粒度的控制，适合需要优化 SQL 语句或处理复杂查询的场景。

### 身份验证和访问控制：SpringSecurity
* SpringSecurity 是 Spring 框架的一个子项目，它提供了全面的安全性解决方案，包括认证（谁是你？）和授权（你能做什么？）。SpringSecurity 可以与 SpringBoot 轻松集成，为在线购物平台提供强大的身份验证和访问控制功能。

### 消息队列控制：SpringAMQP实现RabbitMQ
* SpringAMQP 是 Spring 框架对 AMQP 协议的抽象，它提供了模板来发送和接收消息。RabbitMQ 是一个实现了 AMQP 协议的开源消息代理软件，它支持多种客户端语言。在 SpringBoot 项目中，可以通过 SpringAMQP 来集成 RabbitMQ，实现消息队列控制，以支持异步处理、解耦生产者与消费者等场景。

### 实时通信连接：WebSocket
* 适用于需要实时通信的场景，如实时聊天应用。WebSocket可以保持服务器和客户端之间的持久连接，并允许双方实时发送和接收数据。

## 数据创建
基于前述分析的需求构建虚拟json server数据，并借助MySQL Benchmark绘制ER数据库实体关系图：
![](https://github.com/toubun24/NiHon-IT-Training-Plan/blob/main/imgStorage/EDM202401250229.jpg)

**界面权限rights/顶部栏权限headers**
展示界面中的功能项，主要是区分用户可以看到的界面（如交易相关）和管理员需要用到的界面（如用户管理）
```
[
    {
        "id":int,
        "title":"标签名称",//导航标签名称
        "key":"/路径",//路由路径
        "visible":0/1,//是否有权限，0没有，1有；为方便后续使用采用0/1值而不采用boolean值，下同
    },
    {
        ...
    },
]
```

**界面子项children**
设计中不存在“子项的子项”，因此只需要写入基本的标签信息即可
```
[
    {
        "id":int,
        "title":"标签名称",//导航标签名称
        "key":"/路径",//路由路径
        "visible":0/1,//是否有权限，0没有，1有
        "rightId":int,//对应界面权限right的id
        "grade":int,
    },
    {
        ...
    },
]
```

**商品属性goods**
```
[
    {
        "id":int,
        "num":int,//商品在售数量（库存数量）
        "userId":int,//卖家的账号id
        "state":int,//商品链接状态，0草稿箱，1发布待审核，2已发布，3审核未通过，4卖家已下架，5已售罄，6管理员下架
        "publishTime":int,//发布时间
        "introduction":string,//商品详情介绍
        "yuanjia":int,//商品原价
        "shoujia":int,//商品现价
        "num":int,//商品库存数量
        "dizhi":array,//发货地址，存在卖家预设默认值
        "fahuofangshi":string,//发货方式，baoyou包邮（无邮费），ziti自提（无邮费），zishe自设（有邮费）
        "youfei":int,//邮费
        "tupian":string,//商品图片名称
        "editTime":int,//商品详情最近修改时间
        "starList":array,//对该商品进行了收藏的用户id数组
        "view":int,//商品详情被浏览次数
        "tagList":array,//商品所带标签对应的id数组
        "auditor":int,//最近一次修改该商品权限的管理员
    },
    {
        ...
    },
]
```

**商品标签tags**
```
[
    {
        "id":int,
        "tagName":string,//商品标签名称
        "tagNum":int,//带有该标签的商品数量
        "state":0/1,//0正常，1被和谐
    },
    {
        ...
    },
]
```

**用户属性users**
```
[
    {
        "id":int,
        "username":string,//用户名，禁止重名
        "stateId":int,//用户状态，1正常，2禁购，3禁售，4封禁，5注销，6管理，7超级管理，8禁用管理
        "password":string,//用户密码
        "starList":array,
        "location":array,//省市区三级位置
        "avatar":string,//用户头像图片名称
        "balance":int,//余额
        "followList":array,//自己关注的用户id数组
        "followerList":array,//关注自己的用户id数组
        "historyList":array,//暂时没用到
        "registerTime":int,//注册时间
        "earn":int,//盈利
    },
    {
        ...
    },
]
```

**交易订单trades**
```
[
    {
        "id":int,
        "buyerId":int,//买家id
        "sellerId":int,//卖家id
        "goodId":int,//对应商品id
        "price":int,//交易价格
        "state":int,//订单进度，0已下单待付款，1已付款待发货，2待收货，3待评价，4申诉中，5已取消，6已退款，7已完成
        "num":int,//交易商品数量
        "orderTime":int,//下单时间
        "editTime":int,//订单详情修改时间
        "note":string,//备注
        "dizhi1":array,//省市区三级粗略收货地址
        "dizhi2":string,//详细收货地址
        "kuaidi":string,//快递单号
        "dot":true/false,//是否有被催发货后的讨嫌的小红点
        "commentBySeller":string,//卖家评价
        "commentByBuyer":string,//买家评价
        "argue":int,//申诉状态，0无申诉，1申诉中，2卖方同意退货，3卖方驳回后等待管理员仲裁，4管理员支持买方退货，5管理员支持卖方驳回申诉，6申诉已撤销
        "argueReason":string,//买家申诉理由
        "argueReply1":string,//申诉流程卖家回复
        "argueReply2":string,//申诉流程管理员回复
        "auditor":int,//该订单申诉仲裁管理员id
        "stars":int,//获评星数
        "publishTime":int,//同goods
        "introduction":string,//同goods
        "yuanjia":int,//同goods
        "shoujia":int//同goods
        "dizhi":array,//同goods
        "fahuofangshi":string//同goods
        "youfei":int//同goods
        "tupian":string//同goods
        "finalEditTime":int,//截至下单产生快照时间前最近一次的商品详情修改时间
        "tagList":array,//同goods
    },
    {
        ...
    },
]
```

**权限控制states**
```
[
    {
        "id":int,
        "rights":array,//有权限的路径数组
    },
    {
        ...
    },
]
```

**聊天记录chats**
```
[
    {
        "id":int,
        "messageType":int,//消息类型，0文本，1图片，后续还可以继续引入其他聊天数据类型
        "content":string,//导航标签名称
        "senderId":int,//用户1的id
        "receiverId":int,//用户2的id
        "time":int,//时间戳
    },
    {
        ...
    },
]
```